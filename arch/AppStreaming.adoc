= OTT流化应用中心 
:toc: macro
:toc-title: 目录
:toclevels: 4
:sectnums:
:imagesdir: ./imgs

toc::[]

== 简介
OTT流化应用中心主要负责对流化应用、流化组件、终端交互等流化相关能力的统一管理。为OTT终端提供流化应用的能力支撑。基于OTT流化应用中心，可以为OTT终端带来丰富的新兴的、亮点的，以来较重计算资源的业务，为运营商创造商业价值和社会价值。如云游戏、云VR、云教育、云医疗、增值业务。

== 系统说明

=== 流化应用管理器
流化应用管理器作为内容工厂，汇聚各种类型的业务内容，通过集成适配、测试、审核、发布，为OTT终端提供丰富的内容资源，并支撑内容的分发部署。
面向内容引入，提供统一的应用开发规范及接入SDK，应用通过一次集成就可以实现在所有类型的终端上线，不再关心终端碎片化、网络碎片化、支付碎片化、等等问题。支持Android、HTML5、Windows各类型的应用接入，并对内容合作伙伴的信息进行管理。

==== 流化应用管理主要包括的基本数据模型
流化应用管理主要包括的基本数据模型有：

1. 应用模型：应用的元数据包括应用ID、应用名称、应用类型、应用来源、应用密钥、应用计费密钥、应用签名、应用开发商、应用审核信息、应用状态、创建信息、等等；
1. 版本模型：版本的元数据包括版本号、应用别名、分类、语言、适用区域、关键词、更新说明、版本名称、版本码、应用包名、文件大小、系统支持、存档路径、支持外设、年份、版本海报地址、版本状态、审核信息、等等；
1. CP模型：CP的基本属性包括CP标识、CP名称、CP类型、电子邮箱、联系电话、说明、创建信息、等等；
1. 终端模型：终端ID、终端名称、终端参数。

==== 流化应用管理器包括的主要功能
基于基本的数据模型，流化应用管理器包括的主要功能有：

1. 应用引入：包括应用信息创建、应用信息编辑、版本管理、等等；
1. 应用审核：包括应用信息审核、应用适配审核、应用内容审核、等等，通过审核保证应用的合规性，及用户体验；
1. 应用发布：将审核通过的流化应用发布到具体业务，支撑业务运营；
1. CP管理：对内容提供商的信息进行管理。


适配完成的流化应用，通过应用流化组件提供的自动注入接口，将流化应用注入到应用流化组件。应用流化组件负责将应用部署到相应的流化引擎服务器上。


=== 应用流化组件
应用流化组件是支撑流化应用的核心子系统，应用流化组件包括应用运行平台、加入管理系统、业务支撑系统、终端插件、等多个部分。应用流化的核心功能，是使用应用虚拟化和低时延编解码的技术，以流化的方式将前端服务器上的音、视频流传输给终端，并将终端的操控信息回传给前端服务器，从而达到能够让用户使用低成本的终端，随时享受各类前端应用及服务的目的。

image::AppStreaming-001.png[]

从核心功能视角，应用流化组件的主要技术特征在上图中有直观的体现。其整体架构被分为前端和终端两个视角，终端主要体现其“瘦”的特性，只要拥有终端流化插件的客户端，就可以将相关的终端组件功能转移至前端，而前端为确保向终端提供完整和优质的服务，需要具备的诸多的核心功能，这些核心功能主要的诉求，是为多种应用（包括但不限于HTML5、2D、3D、Android）的流化承载提供了必要的技术支撑。

==== 应用运行平台
应用运行平台是是整个应用流化组件的核心，是流化应用运行和承载的地方，它可实现各类业务（视频、EPG、游戏、教育、政务等）的虚拟化运行、组合、编码，完成数据流化和内容的分发，并实现终端操控外设映射保障业务的交互体验。
应用运行平台的硬件基于“通用服务器+高性能显示卡”的方式构建，通用服务器的构建方式，可最大程度的保护运营商的硬件投资及硬件资产的可复用性，由应用运行平台所承载的业务一般是具体的基于操作系统的可视化应用，例如街头霸王4、流化门户等，而非传统意义上的后台服务模组，因此其对于显卡资源亦有着较强的依赖。这也是应用运行平台不能运行于IAAS虚拟化环境之上的原因，在目前的技术条件下，IAAS虚拟化技术对于显卡穿透解决的并不十分好，加上其特殊的资源调度策略可能影响应用运行时的用户体验并增加资源消耗，在综合的考量了技术及成本因素后，应用运行平台软件目前均采用直接部署在物理服务器上的方式提供服务。
基于不同的应用场景，硬件的构建方式会存在一定的差异，例如在服务器的CPU选择、显卡数量、内存及硬盘配置等方面均会有不同，但从可靠运行和最适合运营商便捷部署的角度，以下技术特征和需要考量的技术点是相似的：

1. 为适用当前普遍的数据中心机房环境，一般选择通用式机架服务器，可上导轨，中国国标的电源线；
1. 支持IPMI2.0标准，可配置图形化远程管理软件，提供监控、告警、日志、资产等管理功能，支持远程开关机，1. 支持服务器操作系统批量部署；
1. 硬盘支持RAID0、1、10模式，可根据应用模式确定最终RAID方式；
1. 支持可热插拔的冗余电源；
1. 可根据应用及供电情况选用的CPU、内存、及硬盘容量及特性；
1. 可根据应用及供电情况选择何种高性能的显卡；
1. 可根据应用类型选择最终适合的操作系统；
1. 可根据应用类型选择网卡及扩展网卡。

应用运行平台从平台类型视角，可以区分为3D应用运行平台、2D应用运行平台、WEB应用运行平台和Android应用运行平台。而这四个平台从软件功能模组视角，均是比较类似的，它们在软件逻辑组件中，均包含应用运行控制、应用数据管理、应用音视频处理和终端外设映射几个部分的功能。


===== 应用运行控制
应用运行平台其最主要的功能，就是实现应用的部署和运行，而执行这个操作的逻辑组件，即是应用运行控制。应用运行控制根据应用类型的不同，采用不同的参数（例如不同分辨率、不同平台类型等）启动应用，实现多开并保证了应用的隔离性，使其类似运行在一个类“虚拟化”的环境中，并且对应用实施状态监控，当应用在运行时出现问题时，第一时间通知SAE接入管理平台并根据其指令确定下一步的处理方法。应用运行控制模块提供了如下能力的支持：

1. 支持应用的生命周期的控制，包括部署、启动、停止以及运行状态监控等；
1. 支持为应用构建完善运行时环境，支持同一应用及不同应用的在运行时的有效隔离；
1. 支持应用在启动时的传递参数，并可解析在应用适配过程中，针对每个应用构建的不同应用描述文件，根据应用描述文件中定义的参数执行应用，例如应用的输出码率、帧率等；
1. 支持800*600、1280*720等多种分辨率应用的运行；
1. 支持应用的分辨率的向下转换输出，以确保应用的适配性统一；
1. 支持在应用中启动机顶盒本地的应用，例如机顶盒浏览器应用及JS应用；
1. 支持流化应用间的切换；
1. 支持用户行为统计，以SYSLOG格式为统计系统输出原始的事件消息。


===== 应用数据管理
应用运行平台中，一个应用运行的所需的最小环境单元被称之为一个“桌面”，一台服务器根据其运行应用的不同，承载多个“桌面”的同时运行。也正是因此，当用户第一次在使用某应用时，可能时由应用服务器A提供服务，当用户下一次使用时，有可能就是应用服务器B（或应用服务器A的另外一个“桌面”）为其提供服务了。

用户的应用存档，可能是用户的配置信息、用户使用应用的关卡信息、用户在使用WEB类应用时的浏览器Cookie、或者用户的应用行为记录，总之是与应用相关的数据信息。在用户每次启动应用前，应用都会加载此类信息，应用运行平台特殊的运行模式使得对应用的存档处理也提出了额外的要求。假设用户在第一次在应用服务器A上使用完毕应用后退出，则应用数据管理组件会将用户的应用存档信息上传至存储服务器；而当下一次用户在应用服务器B上启动该应用前，应用数据管理组件会将用户的应用存档信息下载并恢复至应用运行目录中。这样一来，用户对于服务器间的切换并无感知，从而达到了形同“本机运行”的用户体验。

应用的存档视应用的不同，一般为1KB到10MB范围内，并且以1KB-100KB居多。由于应用存档的恢复是应用启动的先决条件，因此过大的存档会导致应用启动速度下降，这点是在选择和适配应用过程中需要考量的因素。

===== 应用音视频处理
应用音视频处理组件的主要功能是将应用运行时的音频和视频原始数据进行采集、编码，并且最终通过IP或Cable网络传送给终端。全P帧编码技术能够将运动非常剧烈画面的码率控制在非常平稳的状态下，并在服务器满负荷并发的情况下，仍确保极佳的网络抖动和延时指标，使得网络链路上的相关设备的Buffer可以设定为最低值，终端的解码时延恒定且保持最低。在因网络异常而导致终端解码异常的情况下，可通过从终端发送解码反馈的请求，使得前端插入I帧从而恢复图像显示，确保终端在解码异常情况下可恢复。应用音视频处理组件实现了如下具体功能：

1. 支持H.264及MPEG-2编码；
1. 支持以TS格式封装下发音视频流；
1. 支持TCP和UDP两种传输封装格式；
1. 支持AAC、MP3、 MP2等音频编码格式；
1. 支持音频多种采样率；
1. 对单一射频频点下，每路视频码率支持2Mbps-20Mbps可调；
1. 支持多种视频分辨率的输出，并可支持转码以适应不同终端的要求；
1. 支持视频帧率25-60可调；
1. 可以根据调度要求，调整编码输出策略：包括输出视频码率、输出视频帧率的修改等；
1. 支持在运行过程中针对终端的反馈信息进行处理，可以根据终端的反馈情况决定码流发送策略；
1. 支持IP和Cable两种下行方式，采用Cable方式下行时需采用标准的DVB-C封装，用户的回传指令可支持CM、EOC或LAN等多种不同的回传通道，满足广电多种双向网络环境的要求；
1. 控制整体采集、编码和发送时延在40ms以内。


===== 终端外设映射
终端外设映射组件最重要的功能是将从终端接收到的键值指令传送给前端的应用，使得用户可以实现对应用的操控。终端外设本身是一个非常复杂的体系，它牵扯到多种类型的外设（例如遥控器、鼠标、游戏手柄）、多种协议的外设（例如USB协议）、多个不同厂家的外设（例如北通手柄、索尼PS4手柄、微软XBOX360手柄）等等。而对于这几个分类维度来说，很多时候厂家会自定义的私有标准（或附加的私有标准），例如键盘的会有额外的键值、手柄的按键位置不同。终端外设映射组件实现了如下具体功能：

1. 支持红外遥控器类的外设；
1. 支持各类基于USB协议的外设，例如键盘、鼠标、游戏手柄（PS4、Xbox多类型）、体感手柄等外设，用于支持各类炫酷3D业务；
1. 在终端保证USB口供电充足的情况下，支持多外设的同时接入，支持USB集线器；
1. 支持遥控器、鼠标、键盘、手柄等多种外设键值转化为标准键值及自定义扩展键值，与流化应用进行适配。


===== 多平台类型的划分
为确保对不同的应用类型提供最佳的支持能力，应用运行平台可以根据承载应用类型的不同细分为Web应用运行平台、2D应用运行平台、3D应用运行平台、Android应用运行平台，不同的应用运行平台类型对应了对不同应用场景特定的技术约束条件，以及成本因素。

* **3D应用运行平台**：3D应用运行平台是最常用的平台类型，3D应用运行平台需要基于服务器显卡的能力构建。它主要用于大型的3D类应用的承载，例如云游戏应用、虚拟现实应用，也可以提供基于浏览器的应用的支持。

* **2D应用运行平台**：2D应用运行平台与3D应用运行平台最大的区别是其应用的承载不受限于显卡的约束，由于这类应用的资源消耗一般较低，因此2D应用运行平台的并发数会高于3D应用运行平台。

* ** Web应用运行平台**：WEB应用运行平台是基于3D应用运行平台演进出的平台类型，其重点是面向WEB类应用提供运行时的支撑，同样需要使用显卡的能力。

* **Android应用运行平台**：Android应用运行平台的主要功能是提供对Android类型应用的承载，其重点的目标是为适合在电视上承载的Android类型的应用提供接入能力。


==== 接入管理系统
接入管理系统主要负责用户终端的接入及其会话生命周期的管理，以及处理在终端会话生命周期内的应用的启动停止、资源的统一调度和分配等工作。

接入管理系统由多个系统组件构成，分别为终端接入服务、统一会话调度管理、会话资源管理，这几个组件通过协同工作，为运营商提供基于IP、DVB等异构网络的各类统一接入、交互、控制、资源调度和分配等功能。此外，接入管理系统还能够提供用户的跨区域、多终端的统一接入功能，为多用户不同的终端与应用运行平台、业务支撑系统的通讯提供统一并行的业务交互控制。

===== 终端接入服务
终端接入服务的主要功能，是在用户使用流化应用前，将前端系统和应用所必须的参数进行构造，并使得终端能够将这些参数传递给统一会话调度管理系统、会话资源管理系统及流化应用，供前端使用。接入服务的构造基于WebServer进行构建，由于针对的运营商不同，运营商特定所需使用的终端参数也不尽相同，因此灵活的终端接入服务，是系统可用性的重要保障和前提。

===== 统一会话调度管理
统一会话调度管理由两个模块组成，分别为全局调度服务模块和全局会话管理模块。全局调度服务模块的主要功能，是根据终端系统传入的相关参数为终端系统分配可为其提供服务的会话资源管理系统；全局会话管理模块的主要功能，是负责为用户生成并维护用户的全局会话ID、存储会话相关参数入库，并与会话资源管理子系统之间建立保持连接，定期同步并清理脏会话数据。统一会话调度管理提供了如下能力的支持：

1. 可支持管理多个会话资源管理子系统节点的接入；
1. 支持根据终端接入的参数确定用户的接入的会话资源管理节点，用于在不同部署结构中优化用户的接入处理逻辑；
1. 支持为用户的一次接入生成全局唯一的会话ID；
1. 支持在部分特殊情况下的用户信息补全策略。


===== 会话资源管理
会话资源管理负责维护终端访问流化资源的接入，为应用运行平台提供统一的多地区、多节点的终端寻址，为不同终端提供多业务场景的模式切换及终端功能调用。同时在终端接入与退出过程中根据终端类型及业务关系，提供视频及应用承载资源管理、调度及分配，提供多类型终端的适配，为用户运行态会话提供资源管理控制。会话资源管理直接影响到用户对视频云系统的体验，一个稳定高效的会话资源管理系统对于整体系统运营显得至关重要。


==== 业务支撑系统
业务支撑系统主要是为应用运行平台和接入管理系统提供运行时所需的额外能力支撑，业务支撑系统所具备的功能及其服务体现了流化应用中心的完备性。目前业务支撑系统包括应用运行支撑接口服务、统一管理服务、数据分析服务和存储服务这几个不同的组件。
	
===== 应用运行支撑接口服务
应用流化组件主要承载的目标为应用，因此，对于应用在运行时会提供一些额外的能力支撑，这类应用运行时支撑的接口统称为应用运行支撑接口服务。应用运行支撑接口服务包括但不限于以下接口：

1. 为应用提供数据缓存接口；
1. 为应用提供启动其它流化应用及机顶盒本地应用的接口；
1. 为应用提供退出应用运行平台的相关接口；
1. 为应用提供获取当前插入的外设信息接口。

===== 统一管理服务
业务支撑系统的统一管理服务集部署、配置、日志和监控服务与一身，提供了集成化的产品管控手段，使得系统管理员可以在一套系统中操作，完成全部运维工作。统一管理服务基于B/S架构设计，B/S架构使得操作者可以在网络可达的任何地点对系统进行远程管理。统一管理服务以服务器和抽象的软件服务为视角，因此能够做到与业务的无关性。运维体系内的每台服务器出厂时都会安装一个驻留服务（如果是虚拟机则有标准模板），统一管理服务通过与每台服务器上的驻留服务通讯，完成运维相关的一系列操作，服务器驻留服务对通过它部署的模块提供API接口和标准的调用流程。
统一管理服务提供了如下能力的支持：

1. 支持权限与角色管理，系统中的角色分为应用管理员、系统监控员、系统监视员、系统管理员、超级管理员，各角色对操控的范围可以调整，支持对各个管理角色的操作日志进行查看；
1. 支持完善的服务器、模块及系统监控功能，包括但不限于CPU占用率、内存占用率、磁盘占用率、资源综合状态、服务器状态、桌面使用量、带宽等信息，并具备针对相应的监控项配置阈值的功能，在阈值超范围时进行告警；
1. 支持完善的业务运行状态查询功能，包括用户在线信息查询、根据条件筛选查询、桌面使用状况查询等功能；
1. 支持声光报警、邮件告警、历史告警记录查询、历史告警曲线查询等功能；
1. 支持完善的系统模块部署能力，包括但不限于服务器搜集、模块查询、批量部署和升级、批量配置、任务查看及操作等功能；
1. 支持完善的应用部署能力，包括但不限于应用的添加、删除、信息同步、查询、配置查看、部署查看、批量部署和升级等功能；
1. 支持系统基础配置的查看，基础配置中包含终端的类型、服务器类型的管理、基础的编码类型和分辨率类型等信息；
1. 支持系统模块日志的搜集和查看，以及清理的功能。


===== 数据分析服务
业务支撑系统的数据分析服务为应用运行平台和接入管理系统提供了强大的数据分析能力支撑，使得系统的模块运行时数据、用户在线信息数据、应用使用数据等数据信息能够以报表的形式定期输出，供不同视角的人员进行查看。数据分析体系基于“一份数据、多维度统计输出”的理念进行构建，提供了如下能力的支撑：
1. 支持对用户在线数据进行统计输出；
1. 支持对用户登录、退出次数及原因进行统计输出；
1. 支持系统核心模块的TPS信息进行统计输出；
1. 支持以应用为维度的生命周期内的资源占用情况、用户操作情况进行统计输出；
1. 支持对桌面在一定时间内的资源占用情况、用户操作情况进行统计输出；
1. 支持对单台服务器的资源占用情况、应用运行情况、用户操作情况进行统计输出；
1. 支持对所有的故障信息统计汇总输出。


===== 存储服务
业务支撑系统的存储服务主要功能是为应用运行平台提供存档的存储能力，存储服务提供了如下能力的支持：
1. 支持主要以小文件为主的大量文件存储；
1. 支持快速的文件存取机制。

==== 终端插件
为了简化流化应用落地的复杂性，应用流化组件直接提供流化终端插件，终端只需要根据终端插件的规范完成集成，就可实现启动流化应用，音视频播放、外设数据采集及与前端系统的交互。终端插件的设计及集成具备普适性、可扩展性及易维护性的特点。

终端插件在OTT终端上主要以SDK的形式存在，具体业务通过集成流化终端插件实现流化应用的支持。终端插件与前端的交互主要包括四种类型的接口：

1. 终端接入类：包括获取证书、获取接入地址、等等接口；
1. 会话管理类：包括登录、退出、启动流化应用、资源同步、等等接口；
1. 外设映射类：包括申请映射、外设连接、外设输入、外设输出、等等接口；
1. 音视频类：包括开始推流、解码反馈、音视频数据、等等接口。


=== 流化应用

OTT终端流化应用是集成了流化终端插件的应用，终端流化应用主要负责和终端其他服务完成功能对接，包括与应用浏览器之间的跳转对接、与终端系统服务之间的对接。

1. 与应用浏览器互操作： 运营商EPG通过应用浏览器运行，当用户在EPG上启动某个流化应用时，就会涉及到从应用浏览器跳转启动流化应用的流程。同时当流化应用退出时需要能返回到原来的EPG页面。该部分互操作基于OTT终端成熟的应用间跳转机制实现。
1. 与终端系统服务对接：终端系统服务包括本地应用管理服务、消息服务、本地设置服务、启动(升级)服务、等等。流化应用运行需要与其提供的服务接口完成对接。

